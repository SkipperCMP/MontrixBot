# üìê STEP 2.0 ‚Äî Architecture Specification

**–ü—Ä–æ–µ–∫—Ç:** MontrixBot  
**–í–µ—Ä—Å–∏—è:** v2.0-preA (post-GD)  
**–°—Ç–∞—Ç—É—Å:** Architecture fixed, implementation not started  
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:** SNAPSHOT.md + GD_STEP_2_X_AUTO_REAL.md  
**–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞—Ü–∏–∏:** 2025-12-29  
**–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å:** Europe/Riga  

---

## 1. Scope and Authority

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç:

- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É STEP 2.0,
- **–Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é**,
- –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç STEP 1.x,
- –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥—á–∏–Ω—è–µ—Ç—Å—è:
  - `MontrixBot_Governance.md`
  - `MontrixBot_MasterRules.md`
  - `GD_STEP_2_X_AUTO_REAL.md`
  - `SNAPSHOT.md`

STEP 2.0 —Å—Ç—Ä–æ–∏—Ç—Å—è **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤–µ—Ä—Ö** STEP 1.x.

---

## 2. Core Architectural Principle

STEP 2.0 —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ **Supervisor Layer** –Ω–∞–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º STEP 1.x.

- STEP 1.x:
  - –≤–ª–∞–¥–µ–µ—Ç —Ç–æ—Ä–≥–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π,
  - –∏—Å–ø–æ–ª–Ω—è–µ—Ç –æ—Ä–¥–µ—Ä–∞,
  - —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—è–º–∏,
  - –æ—Å—Ç–∞—ë—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω—ã–º.

- STEP 2.0:
  - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, *—Ä–∞–∑—Ä–µ—à–µ–Ω–æ –ª–∏* –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏,
  - —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∂–∏–º–∞–º–∏ –∞–≤—Ç–æ–Ω–æ–º–∏–∏,
  - —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑—É–µ—Ç pause / resume,
  - –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç—å,
  - –∫–æ–º–º—É–Ω–∏—Ü–∏—Ä—É–µ—Ç —Å —á–µ–ª–æ–≤–µ–∫–æ–º.

STEP 2.0 **–Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –Ω–∞–ø—Ä—è–º—É—é**.

---

## 3. Trading State Machine (FSM)

–ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏:
TRADING_ACTIVE
AUTO_PAUSED
HARD_STOPPED

–î–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–ª–∞–≥:
DRAINING = true | false


### 3.1. State Semantics

- `TRADING_ACTIVE`
  - –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã (–ø—Ä–∏ Gate=ALLOW),
  - –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è.

- `AUTO_PAUSED`
  - –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã,
  - –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –¥–æ–≤–æ–¥—è—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è,
  - –≤–æ–∑–º–æ–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤–æ–∑–≤—Ä–∞—Ç –≤ `TRADING_ACTIVE`.

- `HARD_STOPPED`
  - —Ä—É—á–Ω–æ–π STOP,
  - –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã,
  - –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ **–∑–∞–ø—Ä–µ—â—ë–Ω**,
  - –≤–æ–∑–≤—Ä–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω **—Ç–æ–ª—å–∫–æ** –ø–æ —è–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ —á–µ–ª–æ–≤–µ–∫–∞.

---

## 4. Autonomy Permission Model

–ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: persisted runtime-state.

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ä–µ–∂–∏–º—ã:
MANUAL_ONLY
AUTO_ALLOWED


–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
HARD_STOP (derived)


### 4.1. Rules

- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∞–≤—Ç–æ–Ω–æ–º–∏–∏:
  - –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –ø–æ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ —á–µ–ª–æ–≤–µ–∫–∞**.
- `HARD_STOP`:
  - –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –ª—é–±—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã,
  - –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç Gate.

---

## 5. Gate Engine

### 5.1. Contract

Gate Engine –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
decision: ALLOW | VETO
reasons: [string, string, ...] // 2‚Äì3 –ø—Ä–∏—á–∏–Ω—ã
evidence: opaque references // –¥–ª—è –ª–æ–≥–æ–≤ / PolicyTrace

### 5.2. Constraints

- Gate Engine:
  - –º–æ–∂–µ—Ç **–≤–µ—Ç–∏—Ä–æ–≤–∞—Ç—å**,
  - **–Ω–µ –º–æ–∂–µ—Ç** –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é,
  - –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏,
  - –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–Ω–æ–º–∏–∏.

---

## 6. Pause Manager

–ï–¥–∏–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—É–∑–∞–º–∏.

### 6.1. Transitions

TRADING_ACTIVE -> AUTO_PAUSED
–ø—Ä–∏—á–∏–Ω–∞: Gate=VETO | tech_block | market_condition

AUTO_PAUSED -> TRADING_ACTIVE
—É—Å–ª–æ–≤–∏—è:
- Gate=ALLOW
- AutonomyPolicy = AUTO_ALLOWED

ANY -> HARD_STOPPED
–ø—Ä–∏—á–∏–Ω–∞: —Ä—É—á–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ STOP

HARD_STOPPED -> TRADING_ACTIVE
—É—Å–ª–æ–≤–∏—è:
- —è–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ —á–µ–ª–æ–≤–µ–∫–∞
- Gate evaluated and logged


### 6.2. Canonical Rule

> –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ STOP.

---

## 7. Unified Permission Check

–ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ø—É—Å–∫–∞:
CanOpenNewPosition()

–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. AutonomyPolicy
2. Trading State (PauseManager)
3. Technical Blocks (BNB, etc.)
4. Gate Engine
5. Strategy Lock

–†–µ–∑—É–ª—å—Ç–∞—Ç:
ALLOW | VETO
reasons[]


---

## 8. Strategy Lock (1 Coin = 1 Strategy)

- –í –∫–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏:
  - –æ–¥–Ω–∞ –º–æ–Ω–µ—Ç–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
- Lock —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è:
  - –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏.
- –ü–æ–ø—ã—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞:
  - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π VETO —Å –ø—Ä–∏—á–∏–Ω–æ–π.

–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:
symbol -> strategy_id
-> position_id
-> acquired_at


---

## 9. BNB Manager (Technical Operation)

- BNB auto-topup:
  - –Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è,
  - –≤–∫–ª—é—á–∞–µ—Ç—Å—è / –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è —è–≤–Ω–æ.

–ï—Å–ª–∏ BNB –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:

- –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã,
- –æ—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏ –¥–æ–≤–æ–¥—è—Ç—Å—è –¥–æ –∫–æ–Ω—Ü–∞,
- SIM –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∞–Ω–∞–ª–∏–∑,
- –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ,
- –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è `tech_block = BNB_LOW`.

---

## 10. Risky Command Confirmation

–î–ª—è —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è 2-step protocol:

1. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ + –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–∏—Å–∫–∞
2. –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:
yes / –¥–∞


–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ,
- —Ç–∞–π–º–∞—É—Ç ‚Üí –æ—Ç–º–µ–Ω–∞,
- —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ —è–≤–Ω–æ —Å–æ–æ–±—â–∞–µ—Ç—Å—è —á–µ–ª–æ–≤–µ–∫—É.

---

## 11. Status Surface (`/status`)

–ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π payload:
is_trading: true | false
state: TRADING_ACTIVE | AUTO_PAUSED | HARD_STOPPED
mode: MANUAL_ONLY | AUTO_ALLOWED
why_not: [string, string]
open_position:
symbol
side
entry
current
pnl


–ü—Ä–∏–Ω—Ü–∏–ø:

> –¢–∏—à–∏–Ω–∞ = –≤—Å—ë –æ–∫.

---

## 12. Notifications & Daily Report

### 12.1. Notifications (Telegram)

–û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏:

- –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç–æ—Ä–≥–æ–≤–ª–∏,
- –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–∏—á–∏–Ω –ø–∞—É–∑—ã,
- –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏,
- —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞—Ö (BNB).

–§–æ—Ä–º–∞—Ç:

- –∫–æ—Ä–æ—Ç–∫–æ,
- 2‚Äì3 –ø—Ä–∏—á–∏–Ω—ã,
- –±–µ–∑ –∫–Ω–æ–ø–æ–∫.

### 12.2. Daily Report

- 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏,
- —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è,
- –∫—Ä–∞—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç.

---

## 13. Observability Events (Non-Control)

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:
AUTONOMY_MODE_CHANGED
GATE_DECISION
PAUSE_ENTERED
PAUSE_EXITED
HARD_STOP_TRIGGERED
BNB_BLOCK_ON
BNB_BLOCK_OFF
STRATEGY_LOCK_ACQUIRED
STRATEGY_LOCK_RELEASED
RISKY_CMD_ARMED
RISKY_CMD_CONFIRMED
RISKY_CMD_ABORTED


–°–æ–±—ã—Ç–∏—è:
- –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç —Å–∏—Å—Ç–µ–º–æ–π,
- –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –æ–±—ä—è—Å–Ω–∏–º–æ—Å—Ç–∏ –∏ –∞—É–¥–∏—Ç–∞.

---

## 14. Final Constraints

- STEP 1.x remains immutable.
- SIM does not control REAL.
- UI remains proxy-only.
- Human authority is absolute.
- Manual STOP overrides automation.
- STEP discipline is mandatory.

---

### ‚úî STEP 2.0 Architecture Fixed
