# üîó STEP 2.0 ‚Äî FSM & Integration Mapping

**–ü—Ä–æ–µ–∫—Ç:** MontrixBot  
**–í–µ—Ä—Å–∏—è:** v2.0-preA (post-GD)  
**–°—Ç–∞—Ç—É—Å:** Mapping fixed, implementation not started  
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:**  
- SNAPSHOT.md  
- GD_STEP_2_X_AUTO_REAL.md  
- STEP_2_0_ARCHITECTURE.md  
- STEP_2_0_IMPLEMENTATION_BOUNDARY.md  
- STEP_2_0_MODULE_BREAKDOWN.md  

---

## 1. Purpose

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç:

- —Å–≤—è–∑—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π FSM STEP 2.0 —Å —Ç–æ—á–∫–∞–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–±–µ–∑ –∫–æ–¥–∞),
- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç, –≥–¥–µ –∂–∏–≤—É—Ç –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π,
- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç, –∫–æ–≥–¥–∞ –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è Gate,
- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é —Ç–æ—á–∫—É –∫–æ–Ω—Ç—Ä–æ–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–æ–≤—ã—Ö —Å–¥–µ–ª–æ–∫.

–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç boundary.

---

## 2. Canonical FSM (Reference)

–°–æ—Å—Ç–æ—è–Ω–∏—è:

TRADING_ACTIVE
AUTO_PAUSED
HARD_STOPPED

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–ü—Ä–∞–≤–∏–ª–æ:

> –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `AUTO_PAUSED` –∏ –Ω–∏–∫–æ–≥–¥–∞ –ø–æ—Å–ª–µ `HARD_STOPPED`.

---

## 3. Integration Points (Allowed Only)

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Ç–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ STEP 2.0:

### 3.1. `before_open_position(symbol, strategy_id)`

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
- –≤—ã–∑—ã–≤–∞–µ—Ç `CanOpenNewPosition(symbol, strategy_id)`,
- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ALLOW | VETO` + `reasons[]`,
- –ª–æ–≥–∏—Ä—É–µ—Ç GateDecision (observability).

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–¥–µ–ª–∫–∏,
- –º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é,
- –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É.

---

### 3.2. `trading_cycle_control`

–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
- –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤ —Ç–æ—Ä–≥–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.

–î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è:
- –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–∏–∫–ª –ø—Ä–∏ `AUTO_PAUSED` –∏–ª–∏ `HARD_STOPPED`,
- —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ü–∏–∫–ª –ø—Ä–∏ `TRADING_ACTIVE`.

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–æ–∫,
- –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏.

---

## 4. Gate Evaluation Schedule (Non-Control)

Gate –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç—Å—è –≤ –¥–≤—É—Ö —Ä–µ–∂–∏–º–∞—Ö:

### 4.1. `On-Demand` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π)

Gate –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤:

- `before_open_position(...)`

–ü—Ä–∏—á–∏–Ω–∞:
- —Ä–µ—à–µ–Ω–∏–µ –¥–æ–ø—É—Å–∫–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –Ω–∞ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è.

---

### 4.2. `Periodic` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã–π)

Gate –º–æ–∂–µ—Ç –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è `AUTO_PAUSED` / `AUTO_RESUME`.

–ü—Ä–∞–≤–∏–ª–∞:
- periodic Gate **–Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–¥–µ–ª–∫–∏**,
- periodic Gate –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ `TRADING_ACTIVE <-> AUTO_PAUSED`
  —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `TradingStateMachine`.

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞:
- —Ä–µ–¥–∫–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 30‚Äì120 —Å–µ–∫—É–Ω–¥),
- –±–µ–∑ ‚Äú—à—É–º–Ω—ã—Ö‚Äù —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

---

## 5. State Transition Ownership

### 5.1. Owner

–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è:

- `TradingStateMachine` (PauseManager)

–ù–∏–∫–∞–∫–æ–π –¥—Ä—É–≥–æ–π –º–æ–¥—É–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞–ø—Ä—è–º—É—é –º–µ–Ω—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–∏.

---

### 5.2. Transition Triggers

#### A) Auto Pause Trigger

–¢—Ä–∏–≥–≥–µ—Ä—ã:

- `GateDecision = VETO`
- `tech_block active` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `BNB_LOW`)
- `market_condition` (–µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ Gate VETO)

–ü–µ—Ä–µ—Ö–æ–¥:

TRADING_ACTIVE -> AUTO_PAUSED

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–£—Å–ª–æ–≤–∏—è:

- AutonomyPolicyStore.mode == `AUTO_ALLOWED`
- HARD_STOP –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π output:

- `pause_reasons[]` (2‚Äì3 –ø—Ä–∏—á–∏–Ω—ã)
- event `PAUSE_ENTERED`

---

#### B) Auto Resume Trigger

–¢—Ä–∏–≥–≥–µ—Ä:

- `GateDecision = ALLOW`

–ü–µ—Ä–µ—Ö–æ–¥:

AUTO_PAUSED -> TRADING_ACTIVE

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–£—Å–ª–æ–≤–∏—è:

- AutonomyPolicyStore.mode == `AUTO_ALLOWED`
- HARD_STOP –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π output:

- event `PAUSE_EXITED`
- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º)

---

#### C) Manual STOP Trigger

–¢—Ä–∏–≥–≥–µ—Ä:

- –∫–æ–º–∞–Ω–¥–∞ —á–µ–ª–æ–≤–µ–∫–∞ `/stop`

–ü–µ—Ä–µ—Ö–æ–¥:

ANY -> HARD_STOPPED

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–£—Å–ª–æ–≤–∏—è:

- –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç (—Ä—É—á–Ω–æ–π STOP –∞–±—Å–æ–ª—é—Ç–µ–Ω)

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π output:

- event `HARD_STOP_TRIGGERED`
- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–∫–æ—Ä–æ—Ç–∫–æ)

–ó–∞–ø—Ä–µ—Ç:

- –ª—é–±—ã–µ auto-resume –ø–µ—Ä–µ—Ö–æ–¥—ã –ø—Ä–∏ `HARD_STOPPED`.

---

#### D) Manual RESUME Trigger

–¢—Ä–∏–≥–≥–µ—Ä:

- –∫–æ–º–∞–Ω–¥–∞ —á–µ–ª–æ–≤–µ–∫–∞ `/resume`

–ü–µ—Ä–µ—Ö–æ–¥:

HARD_STOPPED -> TRADING_ACTIVE

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–£—Å–ª–æ–≤–∏—è:

- Gate evaluated and logged (ALLOW/VETO —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è),
- –µ—Å–ª–∏ Gate=VETO:
  - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ ACTIVE,
  - —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è –≤ `AUTO_PAUSED` –∏–ª–∏ –∏–Ω–æ–π pause-state,
  - –ø—Ä–∏—á–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω—ã —á–µ–ª–æ–≤–µ–∫—É.

–ü—Ä–∞–≤–∏–ª–æ:
- resume –∫–æ–º–∞–Ω–¥–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ ‚Äú–ª–æ–º–∞–µ—Ç‚Äù Gate, –æ–Ω–∞ —Ç–æ–ª—å–∫–æ —Å–Ω–∏–º–∞–µ—Ç HARD_STOP.

---

## 6. DRAINING Semantics (Open Positions)

–û–±—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ:

- –ø—Ä–∏ –ª—é–±–æ–º pause/stop:
  - –Ω–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã,
  - –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–æ–≤–æ–¥—è—Ç—Å—è –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è STEP 1.x.

–§–ª–∞–≥:

DRAINING = true

markdown
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–º–æ–∂–µ—Ç –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –∫–∞–∫:

- `open_positions_count > 0` AND `state != TRADING_ACTIVE`

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:
- STEP 2.0 –Ω–µ –≤–º–µ—à–∏–≤–∞–µ—Ç—Å—è –≤ –∑–∞–∫—Ä—ã—Ç–∏–µ/–≤–µ–¥–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏.

---

## 7. Status Surface Mapping

`/status` –æ–±—è–∑–∞–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å:

- `state` –∏–∑ `TradingStateMachine`,
- `mode` –∏–∑ `AutonomyPolicyStore`,
- `why_not[]`:
  - –ø—Ä–∏ `AUTO_PAUSED`: –ø—Ä–∏—á–∏–Ω—ã –ø–∞—É–∑—ã,
  - –ø—Ä–∏ `HARD_STOPPED`: —è–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ "manual stop" + 1‚Äì2 –≤—Ç–æ—Ä–∏—á–Ω—ã–µ,
- `open_position`:
  - read-only –∏–∑ STEP 1.x.

---

## 8. Notifications Mapping (Minimal)

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–æ–±—ã—Ç–∏—è:

- `PAUSE_ENTERED` (–µ—Å–ª–∏ –ø—Ä–∏—á–∏–Ω—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å)
- `PAUSE_EXITED`
- `HARD_STOP_TRIGGERED`
- `BNB_BLOCK_ON/OFF`

–ü—Ä–∞–≤–∏–ª–∞:
- –∫–æ—Ä–æ—Ç–∫–æ,
- 2‚Äì3 –ø—Ä–∏—á–∏–Ω—ã,
- –±–µ–∑ –∫–Ω–æ–ø–æ–∫,
- –Ω–µ —Å–ø–∞–º–∏—Ç—å –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö periodic Gate.

---

## 9. Read-Only Inputs from STEP 1.x (No Modification)

STEP 2.0 –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ —á–∏—Ç–∞—Ç—å:

- –Ω–∞–ª–∏—á–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏ –ø–æ symbol,
- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–¥–µ–ª–∫–∏ (open/closed),
- –∫—Ä–∞—Ç–∫–∏–π PnL,
- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) health/ready indicators –∫–∞–∫ observability.

STEP 2.0 –Ω–µ –º–æ–∂–µ—Ç:

- –º–µ–Ω—è—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é,
- –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ä–¥–µ—Ä–æ–≤,
- –º–µ–Ω—è—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞,
- –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–¥–µ–ª–∫—É.

---

## 10. Compliance Checklist (Hard)

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å:

- `before_open_position(...)` –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è,
- –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `TradingStateMachine`,
- auto-resume –∑–∞–ø—Ä–µ—â—ë–Ω –ø–æ—Å–ª–µ manual stop,
- Gate evaluated and logged –Ω–∞ `before_open_position`,
- `/status` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ read-only –¥–∞–Ω–Ω—ã–µ,
- —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ ‚Äú—à—É–º–æ–≤–æ–π –∫–∞–Ω–∞–ª‚Äù.

---

### ‚úî STEP 2.0 FSM & Integration Mapping Fixed