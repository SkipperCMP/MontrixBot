# üß≠ STEP 2.0 ‚Äî Command Surface & Risky Confirm Protocol

**–ü—Ä–æ–µ–∫—Ç:** MontrixBot  
**–í–µ—Ä—Å–∏—è:** v2.0-preA (post-GD)  
**–°—Ç–∞—Ç—É—Å:** Command surface fixed, implementation not started  
**–û—Å–Ω–æ–≤–∞–Ω–∏–µ:**  
- SNAPSHOT.md  
- GD_STEP_2_X_AUTO_REAL.md  
- STEP_2_0_ARCHITECTURE.md  
- STEP_2_0_IMPLEMENTATION_BOUNDARY.md  
- STEP_2_0_MODULE_BREAKDOWN.md  
- STEP_2_0_FSM_INTEGRATION.md  

---

## 1. Purpose

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç:

- —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç **–ø–æ–ª–Ω—É—é –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥** STEP 2.0,
- –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç **risk classification** –∫–æ–º–∞–Ω–¥,
- –∑–∞–¥–∞—ë—Ç **2-step confirm protocol**,
- –∑–∞–ø—Ä–µ—â–∞–µ—Ç ‚Äú—Ç–∏—Ö–∏–µ‚Äù –∏ –Ω–µ—è–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.

–î–æ–∫—É–º–µ–Ω—Ç **–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏** –∏ –Ω–µ —Ä–∞—Å—à–∏—Ä—è–µ—Ç boundary.

---

## 2. Command Principles (Hard)

- –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∏–Ω–∏—Ü–∏–∏—Ä—É—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫–æ–º**.
- UI / Telegram ‚Äî **proxy-only** (–Ω–∏–∫–∞–∫–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏).
- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞:
  - –ª–∏–±–æ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è,
  - –ª–∏–±–æ —è–≤–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è,
  - –ª–∏–±–æ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
- –õ—é–±–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è **2‚Äì3 –ø—Ä–∏—á–∏–Ω–∞–º–∏**.
- –ù–∏–∫–∞–∫–∏—Ö ‚Äúbest guess‚Äù –∏–ª–∏ –∞–≤—Ç–æ-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–π.

---

## 3. Command Categories

### 3.1. Informational (Safe)

–ö–æ–º–∞–Ω–¥—ã, –Ω–µ –º–µ–Ω—è—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

- `/status`
- `/help` (–µ—Å–ª–∏ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è)
- `/version` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–ü—Ä–∞–≤–∏–ª–∞:**
- –Ω–µ —Ç—Ä–µ–±—É—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è,
- –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ risky,
- –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ Gate / FSM.

---

### 3.2. Mode & State Control (Risky)

–ö–æ–º–∞–Ω–¥—ã, –º–µ–Ω—è—é—â–∏–µ —Ä–µ–∂–∏–º—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–ª–∏.

- `/set_mode MANUAL_ONLY`
- `/set_mode AUTO_ALLOWED`
- `/pause`
- `/resume`
- `/stop`

**–ü—Ä–∞–≤–∏–ª–∞:**
- —Å—á–∏—Ç–∞—é—Ç—Å—è **risky**,
- —Ç—Ä–µ–±—É—é—Ç 2-step confirm,
- –≤—Å–µ–≥–¥–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.

---

### 3.3. Technical Operations (Risky)

–ö–æ–º–∞–Ω–¥—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞.

- `/bnb_autotopup on`
- `/bnb_autotopup off`

**–ü—Ä–∞–≤–∏–ª–∞:**
- —Å—á–∏—Ç–∞—é—Ç—Å—è **risky**,
- —Ç—Ä–µ–±—É—é—Ç 2-step confirm,
- –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏.

---

### 3.4. Future-Reserved (Forbidden Now)

–õ—é–±—ã–µ –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ:

- –∏–Ω–∏—Ü–∏–∏—Ä—É—é—Ç —Å–¥–µ–ª–∫–∏,
- —É–ø—Ä–∞–≤–ª—è—é—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏,
- –º–µ–Ω—è—é—Ç —Ä–∏—Å–∫-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã,
- –º–µ–Ω—è—é—Ç SIM –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

**–°—Ç–∞—Ç—É—Å:** –∑–∞–ø—Ä–µ—â–µ–Ω—ã –≤ STEP 2.0.

---

## 4. Risky Command Confirmation (2-Step)

### 4.1. Arming Phase

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ risky-–∫–æ–º–∞–Ω–¥—ã —Å–∏—Å—Ç–µ–º–∞ –æ–±—è–∑–∞–Ω–∞:

- –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ,
- –æ–±—ä—è—Å–Ω–∏—Ç—å —Ä–∏—Å–∫,
- –∑–∞–ø—Ä–æ—Å–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (–∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π):

‚ö†Ô∏è –û–ø–∞—Å–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞

–ö–æ–º–∞–Ω–¥–∞: <command>
–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∏—Å–∫:

<reason 1>

<reason 2>

–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:
–¥–∞ / yes

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

---

### 4.2. Confirmation Phase

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å **–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º**,
- –æ–¥–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ = –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞,
- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è**.

–î–æ–ø—É—Å—Ç–∏–º—ã–µ –æ—Ç–≤–µ—Ç—ã:

–¥–∞
yes

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–õ—é–±–æ–π –¥—Ä—É–≥–æ–π –≤–≤–æ–¥:
- –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è,
- –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º.

---

### 4.3. Timeout & Abort

–ï—Å–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ:

- –∫–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è,
- —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è,
- –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:

‚è≥ –ö–æ–º–∞–Ω–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

---

## 5. Execution & Result Reporting

–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:

- –∫–æ–º–∞–Ω–¥–∞ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è,
- –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —è–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: <command>

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ:

‚ùå –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞

–ü—Ä–∏—á–∏–Ω—ã:

<reason 1>

<reason 2>

–í–æ–∑–º–æ–∂–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:

<next step>
yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

---

## 6. Command ‚Üí FSM Mapping

| –ö–æ–º–∞–Ω–¥–∞      | FSM Effect                          |
|--------------|-------------------------------------|
| `/pause`     | `TRADING_ACTIVE -> AUTO_PAUSED`     |
| `/stop`      | `ANY -> HARD_STOPPED`               |
| `/resume`    | `HARD_STOPPED -> TRADING_ACTIVE*`   |
| `/set_mode`  | AutonomyPolicyStore update          |

\* –ü—Ä–∏ `/resume` Gate **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è.  
–ï—Å–ª–∏ Gate=VETO ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –Ω–µ —Å–æ–≤–µ—Ä—à–∞–µ—Ç—Å—è, –ø—Ä–∏—á–∏–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —á–µ–ª–æ–≤–µ–∫—É.

---

## 7. Idempotency Rules

- –ü–æ–≤—Ç–æ—Ä –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏:
  - –Ω–µ –º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ,
  - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç:

‚ÑπÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Äî –∫–æ–º–∞–Ω–¥–∞ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

---

## 8. Audit & Observability

–ö–∞–∂–¥–∞—è risky-–∫–æ–º–∞–Ω–¥–∞ –æ–±—è–∑–∞–Ω–∞ –ø–æ—Ä–æ–∂–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏—è:

RISKY_CMD_ARMED
RISKY_CMD_CONFIRMED
RISKY_CMD_ABORTED

yaml
–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- FSM transitions,
- autonomy mode changes,
- tech block changes.

–°–æ–±—ã—Ç–∏—è:
- –Ω–µ —É–ø—Ä–∞–≤–ª—è—é—Ç —Å–∏—Å—Ç–µ–º–æ–π,
- –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è explainability –∏ –∞—É–¥–∏—Ç–∞.

---

## 9. Forbidden Patterns (Hard Ban)

–ó–∞–ø—Ä–µ—â–µ–Ω–æ:

- auto-confirm,
- ‚Äúyes‚Äù –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞,
- –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ —è–≤–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞,
- –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥ –ø–æ–¥ –æ–¥–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ,
- silent fallback.

---

## 10. Compliance Checklist

–ü–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π CommandRouter –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å:

- –≤—Å–µ risky-–∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ 2-step confirm,
- –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–µ,
- –∫–æ–º–∞–Ω–¥—ã –Ω–µ –∏–Ω–∏—Ü–∏–∏—Ä—É—é—Ç —Å–¥–µ–ª–∫–∏,
- `/status` –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è,
- UI –æ—Å—Ç–∞—ë—Ç—Å—è proxy-only.

---

### ‚úî STEP 2.0 Command Surface Fixed